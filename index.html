<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Street Lighting Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; padding:0; }
#map { width:100%; height:100vh; }
.custom-control {
  position:absolute; top:40px; right:10px; z-index:1000;
  background:white; padding:5px 10px; border-radius:4px; font-family:sans-serif;
}
#reported-counter {
  position:absolute; top:10px; right:10px; z-index:1000;
  background:white; padding:6px 12px; border-radius:4px; font-weight:bold;
  box-shadow:0 0 6px rgba(0,0,0,0.3); font-family:sans-serif;
}
#zoom-display {
  position:absolute; top:70px; right:10px; z-index:1000;
  background:white; padding:6px 12px; border-radius:4px; font-family:sans-serif;
  box-shadow:0 0 6px rgba(0,0,0,0.3);
}
</style>
</head>
<body>
<div id="map"></div>
<div class="custom-control">
  <select id="layer-toggle">
    <option value="report">Report</option>
    <option value="reported">Reported</option>
  </select>
</div>
<div id="reported-counter">Reported Flags: 0</div>
<div id="zoom-display">Zoom: 0</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
var map = L.map('map').setView([53.96, -1.08], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

var reportLayer = L.layerGroup();
var reportedLayer = L.layerGroup();

const GEOJSON_URL = "Street_lighting.geojson";
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH2VV-FfOWWKyr4XRaVAPxWL-8zn2dKmYB_2XxxKG_b9IfJVtgGU5xcFje_wh7WW_AyGpDABQpMlFo/pub?gid=27103071&single=true&output=csv';

let geoLookup = {};
let reportedData = [];

// --- Load GeoJSON ---
fetch(GEOJSON_URL).then(res => res.json()).then(data => {
  data.features.forEach(f => {
    const id = f.properties.LP_UNIQUE_REF || f.properties.IIT_NE_ID;
    if(id) geoLookup[id] = {
      coords: f.geometry.coordinates,
      desc: f.properties.DESCRIPTION || "",
      road: f.properties.ROAD_NAME || "",
      ward: f.properties.WARD || "",
      loc: f.properties.LOCATION || ""
    };
  });

  // --- Build Report overlay ---
  Object.keys(geoLookup).forEach(id => {
    const g = geoLookup[id];
    const popupHTML = `<b>Streetlight Ref:</b> ${id}<br>
      <b>Location:</b> ${g.loc}<br>
      <b>Road:</b> ${g.road}<br>
      <b>Ward:</b> ${g.ward}<br>
      <button onclick="report('${id}','Low')">Low</button>
      <button onclick="report('${id}','Med')">Med</button>
      <button onclick="report('${id}','High')">High</button>`;
    const marker = L.marker([g.coords[1], g.coords[0]]).bindPopup(popupHTML);
    reportLayer.addLayer(marker);
  });

  map.addLayer(reportLayer);
});

// --- Load Reported CSV once and store ---
function fetchReportedData() {
  Papa.parse(CSV_URL, { download:true, header:true, skipEmptyLines:true, complete:function(results){
    reportedData = results.data.filter(r => r.LP_UNIQUE_REF);
    document.getElementById('reported-counter').textContent = "Reported Flags: " + reportedData.length;
    renderReportedMarkers();
  }});
}
fetchReportedData();
setInterval(fetchReportedData, 30000); // refresh every 30s

// --- Render markers only within bounds & zoom ---
function renderReportedMarkers() {
  reportedLayer.clearLayers();
  const bounds = map.getBounds();
  const zoom = map.getZoom();
  if(zoom < 18) return; // only show at zoom 18+
  
  reportedData.forEach(r => {
    const g = geoLookup[r.LP_UNIQUE_REF];
    if(!g) return;
    const latlng = [g.coords[1], g.coords[0]];
    if(!bounds.contains(latlng)) return; // skip markers outside view

    const color = r.Issue_Description && r.Issue_Description.toLowerCase().includes('high') ? 'red' :
                  r.Issue_Description && r.Issue_Description.toLowerCase().includes('med') ? 'orange' : 'green';
    const marker = L.circleMarker(latlng, { radius:8, fillColor:color, color:'#000', weight:1, opacity:1, fillOpacity:0.8 })
      .bindPopup(`<b>Streetlight Ref:</b>${r.LP_UNIQUE_REF}<br><b>Issue:</b>${r.Issue_Description}<br><b>Timestamp:</b>${r.Timestamp}`);
    reportedLayer.addLayer(marker);
  });
}

// --- Toggle layer ---
document.getElementById('layer-toggle').addEventListener('change',function(){
  if(this.value==='report'){ map.removeLayer(reportedLayer); map.addLayer(reportLayer); }
  else{ map.removeLayer(reportLayer); map.addLayer(reportedLayer); }
});

// --- Update zoom & re-render markers on move/zoom ---
map.on('zoomend moveend', function(){
  document.getElementById('zoom-display').textContent = "Zoom: "+map.getZoom();
  renderReportedMarkers();
});

// --- Report function ---
function report(id,severity){
  const g = geoLookup[id];
  const formLink = "https://docs.google.com/forms/d/e/1FAIpQLSf5Q35Lody4pbcu9SKh3jxh3R5qqqLNajV6gzQgci6PZRB7Dg/viewform?usp=pp_url" +
    "&entry.1636359810=" + encodeURIComponent(id) +
    "&entry.476717375=" + encodeURIComponent(g.loc) +
    "&entry.704251959=" + encodeURIComponent(g.road) +
    "&entry.561605536=" + encodeURIComponent(g.ward) +
    "&entry.1808870260=" + encodeURIComponent(severity);
  window.open(formLink,'_blank');
}
</script>
</body>
</html>
