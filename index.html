<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Street Lighting Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; padding:0; }
#map { width:100%; height:100vh; }
.custom-control {
  position:absolute;
  top:40px;
  right:10px;
  z-index:1000;
  background:white;
  padding:5px 10px;
  border-radius:4px;
  font-family:sans-serif;
}
#reported-counter, #zoom-level {
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  background:white;
  padding:6px 12px;
  border-radius:4px;
  font-weight:bold;
  box-shadow:0 0 6px rgba(0,0,0,0.3);
  font-family:sans-serif;
  margin-bottom:4px;
}
#zoom-level { top:50px; }
</style>
</head>
<body>
<div id="map"></div>
<div class="custom-control">
  <select id="layer-toggle">
    <option value="report">Report</option>
    <option value="reported">Reported</option>
  </select>
</div>
<div id="reported-counter">Reported Flags: 0</div>
<div id="zoom-level">Zoom: 0</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const GEOJSON_URL = "Street_lighting.geojson";
const REPORTED_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH2VV-FfOWWKyr4XRaVAPxWL-8zn2dKmYB_2XxxKG_b9IfJVtgGU5xcFje_wh7WW_AyGpDABQpMlFo/pub?gid=27103071&single=true&output=csv';
const ZOOM_THRESHOLD = 18;

var map = L.map('map').setView([53.96, -1.08], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

var reportLayer = L.layerGroup();
var reportedLayer = L.layerGroup();

let geoData = [];
let reportedData = [];

// --- Load GeoJSON for Report overlay ---
fetch(GEOJSON_URL)
  .then(res => res.json())
  .then(data => {
    geoData = data.features.map(f => {
      const id = f.properties.LP_UNIQUE_REF || f.properties.IIT_NE_ID;
      return {
        id: id,
        coords: [f.geometry.coordinates[1], f.geometry.coordinates[0]],
        desc: f.properties.DESCRIPTION || "",
        road: f.properties.ROAD_NAME || "",
        ward: f.properties.WARD || "",
        loc: f.properties.LOCATION || ""
      };
    });
    updateReportMarkers();
  });

// --- Load Reported CSV ---
function loadReportedData(callback) {
  Papa.parse(REPORTED_CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      reportedData = results.data.filter(r => r.LP_UNIQUE_REF);
      document.getElementById('reported-counter').textContent = "Reported Flags: "+reportedData.length;
      if(callback) callback();
    }
  });
}

// --- Add markers for Report overlay ---
function updateReportMarkers() {
  reportLayer.clearLayers();
  if(map.getZoom() < ZOOM_THRESHOLD) return;
  const bounds = map.getBounds();
  geoData.forEach(d => {
    if(bounds.contains(d.coords)) {
      const formLink = "https://docs.google.com/forms/d/e/1FAIpQLSf5Q35Lody4pbcu9SKh3jxh3R5qqqLNajV6gzQgci6PZRB7Dg/viewform?usp=pp_url" +
                       "&entry.1636359810=" + encodeURIComponent(d.id) +
                       "&entry.476717375=" + encodeURIComponent(d.loc) +
                       "&entry.704251959=" + encodeURIComponent(d.road) +
                       "&entry.561605536=" + encodeURIComponent(d.ward);
      const popup = `<b>Streetlight Ref:</b> ${d.id}<br>
                     <b>Description:</b> ${d.desc}<br>
                     <b>Road:</b> ${d.road}<br>
                     <b>Ward:</b> ${d.ward}<br>
                     <a href="${formLink}" target="_blank">Report a problem</a>`;
      L.marker(d.coords).bindPopup(popup).addTo(reportLayer);
    }
  });
}

// --- Add markers for Reported overlay ---
function updateReportedMarkers() {
  reportedLayer.clearLayers();
  if(map.getZoom() < ZOOM_THRESHOLD) return;
  const bounds = map.getBounds();
  reportedData.forEach(r => {
    const coords = geoData.find(d => d.id === r.LP_UNIQUE_REF)?.coords;
    if(coords && bounds.contains(coords)) {
      let issue = r.Issue_Description || '';
      let severity = 'Low';
      if(issue.toLowerCase().includes('med')) severity='Med';
      else if(issue.toLowerCase().includes('high')) severity='High';
      let color = severity==='Low'?'green':severity==='Med'?'orange':'red';
      const marker = L.circleMarker(coords, {radius:8, fillColor:color, color:'#000', weight:1, opacity:1, fillOpacity:0.8})
        .bindPopup(`<b>Streetlight Ref:</b>${r.LP_UNIQUE_REF}<br>
                    <b>Issue:</b>${issue}<br>
                    <b>Timestamp:</b>${r.Timestamp}`);
      reportedLayer.addLayer(marker);
    }
  });
}

// --- Initial load ---
loadReportedData(updateReportedMarkers);
map.addLayer(reportLayer);

// --- Handle zoom/move ---
map.on('zoomend moveend', () => {
  document.getElementById('zoom-level').textContent = "Zoom: "+map.getZoom();
  if(document.getElementById('layer-toggle').value==='report') updateReportMarkers();
  else updateReportedMarkers();
});

// --- Dropdown toggle ---
document.getElementById('layer-toggle').addEventListener('change', function() {
  const val = this.value;
  if(val==='report') {
    if(map.hasLayer(reportedLayer)) map.removeLayer(reportedLayer);
    map.addLayer(reportLayer);
    updateReportMarkers();
  } else {
    if(map.hasLayer(reportLayer)) map.removeLayer(reportLayer);
    map.addLayer(reportedLayer);
    updateReportedMarkers();
  }
});
</script>
</body>
</html>
