<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Debug Reported Flags</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; padding:0; }
#map { width:100%; height:100vh; }
#reported-counter {
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  background:white;
  padding:6px 12px;
  border-radius:4px;
  font-weight:bold;
  box-shadow:0 0 6px rgba(0,0,0,0.3);
  font-family:sans-serif;
}
</style>
</head>
<body>
<div id="map"></div>
<div id="reported-counter">Reported Flags: 0</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
var map = L.map('map').setView([53.96, -1.08], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

var reportedLayer = L.layerGroup().addTo(map);

const GEOJSON_URL = "Street_lighting.geojson";
const REPORTED_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH2VV-FfOWWKyr4XRaVAPxWL-8zn2dKmYB_2XxxKG_b9IfJVtgGU5xcFje_wh7WW_AyGpDABQpMlFo/pub?gid=27103071&single=true&output=csv';

// --- Load GeoJSON ---
let geoLookup = {};
fetch(GEOJSON_URL)
  .then(res => res.json())
  .then(data => {
    data.features.forEach(f => {
      const id = f.properties.LP_UNIQUE_REF || f.properties.IIT_NE_ID;
      if(id) geoLookup[id] = f.geometry.coordinates;
    });
    console.log("GeoLookup keys:", Object.keys(geoLookup));

    // --- Load Reported CSV ---
    Papa.parse(REPORTED_CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        console.log("Reported CSV raw data:", results.data);

        const reported = results.data.filter(r => r.LP_UNIQUE_REF);
        console.log("Filtered reported:", reported);

        let markersAdded = 0;
        reported.forEach(r => {
          const id = r.LP_UNIQUE_REF;
          const coords = geoLookup[id];
          if(!coords) {
            console.warn("No coordinates found for:", id);
            return;
          }

          const marker = L.circleMarker([coords[1], coords[0]], {
            radius: 8,
            fillColor: 'red',
            color: '#000',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          }).bindPopup("<b>Streetlight Ref:</b> " + id);

          reportedLayer.addLayer(marker);
          markersAdded++;
        });

        document.getElementById('reported-counter').textContent = "Reported Flags: " + markersAdded;
        console.log("Total markers added:", markersAdded);
      }
    });
  });
</script>
</body>
</html>
