<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Street Lighting Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
body { margin:0; padding:0; }
#map { width:100%; height:100vh; }
.custom-control {
  position:absolute;
  top:40px;
  right:10px;
  z-index:1000;
  background:white;
  padding:5px 10px;
  border-radius:4px;
  font-family:sans-serif;
}
#reported-counter {
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  background:white;
  padding:6px 12px;
  border-radius:4px;
  font-weight:bold;
  box-shadow:0 0 6px rgba(0,0,0,0.3);
  font-family:sans-serif;
}
.flag-btn {
  display:block;
  margin-top:5px;
  padding:3px 6px;
  background:#ff4444;
  color:white;
  border:none;
  border-radius:3px;
  cursor:pointer;
}
</style>
</head>
<body>
<div id="map"></div>
<div class="custom-control">
  <select id="layer-toggle">
    <option value="report">Report</option>
    <option value="reported">Reported</option>
  </select>
</div>
<div id="reported-counter">Reported Flags: 0</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const map = L.map('map').setView([53.96, -1.08], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

const reportLayer = L.markerClusterGroup();
const reportedLayer = L.layerGroup();

const GEOJSON_URL = "Street_lighting.geojson";
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH2VV-FfOWWKyr4XRaVAPxWL-8zn2dKmYB_2XxxKG_b9IfJVtgGU5xcFje_wh7WW_AyGpDABQpMlFo/pub?gid=27103071&single=true&output=csv';
const FLAG_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbygHeD8oVTvd_W5rPRRSIK6gtsuTjKx_XFbI4paN5AknZEObdsGLgQqj9-h6XdbIGfbPA/exec';

let geoLookup = {};

// Load GeoJSON for coordinates and Report overlay
fetch(GEOJSON_URL)
  .then(res => res.json())
  .then(geojsonData => {
    geojsonData.features.forEach(f => {
      const id = f.properties.LP_UNIQUE_REF || f.properties.IIT_NE_ID;
      if(!id) return;

      geoLookup[id] = f.geometry.coordinates;

      const desc = f.properties.DESCRIPTION || "";
      const road = f.properties.ROAD_NAME || "";
      const ward = f.properties.WARD || "";
      const loc = f.properties.LOCATION || "";

      // Only add a marker with a popup to allow reporting
      const formLink = "https://docs.google.com/forms/d/e/1FAIpQLSf5Q35Lody4pbcu9SKh3jxh3R5qqqLNajV6gzQgci6PZRB7Dg/viewform?usp=pp_url" +
        "&entry.1636359810=" + encodeURIComponent(id) +
        "&entry.476717375=" + encodeURIComponent(loc) +
        "&entry.704251959=" + encodeURIComponent(road) +
        "&entry.561605536=" + encodeURIComponent(ward);

      const popupContent = `<b>Streetlight Ref:</b> ${id}<br>
                            <b>Description:</b> ${desc}<br>
                            <b>Road:</b> ${road}<br>
                            <b>Ward:</b> ${ward}<br>
                            <a href="${formLink}" target="_blank">Report a problem</a>`;

      const marker = L.marker([f.geometry.coordinates[1], f.geometry.coordinates[0]])
        .bindPopup(popupContent);

      reportLayer.addLayer(marker);
    });

    // Show Report overlay by default
    map.addLayer(reportLayer);

    // Load reported flags from CSV
    function loadReportedLayer() {
      reportedLayer.clearLayers();
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const reported = results.data.filter(r => r.LP_UNIQUE_REF);
          document.getElementById('reported-counter').textContent = "Reported Flags: " + reported.length;

          reported.forEach(r => {
            const id = r.LP_UNIQUE_REF;
            const timestamp = r.Timestamp || '';
            const coords = geoLookup[id];
            if(!coords) return;

            const marker = L.circleMarker([coords[1], coords[0]], {
              radius:8,
              fillColor:'#ff4444',
              color:'#000',
              weight:1,
              opacity:1,
              fillOpacity:0.8
            });

            const btnHTML = `<button class="flag-btn" onclick="flagRemoved('${id}')">Flag Removed</button>`;

            marker.bindPopup(`<b>Streetlight Ref:</b> ${id}<br><b>Timestamp:</b> ${timestamp}<br>${btnHTML}`);

            reportedLayer.addLayer(marker);
          });
        }
      });
    }

    loadReportedLayer();
    setInterval(loadReportedLayer, 60000); // refresh every 60s
  });

// Flag Removed function
function flagRemoved(id) {
  fetch(`${FLAG_WEBAPP_URL}?LP_UNIQUE_REF=${encodeURIComponent(id)}`)
    .then(res => res.json())
    .then(data => alert('Flag submitted!'))
    .catch(err => alert('Error submitting flag: '+err));
}

// Dropdown toggle
document.getElementById('layer-toggle').addEventListener('change', function() {
  const val = this.value;
  if(val==='report') {
    if(map.hasLayer(reportedLayer)) map.removeLayer(reportedLayer);
    map.addLayer(reportLayer);
  } else if(val==='reported') {
    if(map.hasLayer(reportLayer)) map.removeLayer(reportLayer);
    map.addLayer(reportedLayer);
  }
});
</script>
</body>
</html>
