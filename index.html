<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Street Lighting Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; padding:0; }
#map { width:100%; height:100vh; }
.custom-control {
  position:absolute;
  top:40px;
  right:10px;
  z-index:1000;
  background:white;
  padding:5px 10px;
  border-radius:4px;
  font-family:sans-serif;
}
#reported-counter {
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  background:white;
  padding:6px 12px;
  border-radius:4px;
  font-weight:bold;
  box-shadow:0 0 6px rgba(0,0,0,0.3);
  font-family:sans-serif;
}
#zoom-display {
  position:absolute;
  top:50px;
  right:10px;
  z-index:1000;
  background:white;
  padding:4px 8px;
  border-radius:4px;
  font-family:sans-serif;
  box-shadow:0 0 4px rgba(0,0,0,0.3);
}
</style>
</head>
<body>
<div id="map"></div>
<div class="custom-control">
  <select id="layer-toggle">
    <option value="report">Report</option>
    <option value="reported">Reported</option>
  </select>
</div>
<div id="reported-counter">Reported Flags: 0</div>
<div id="zoom-display">Zoom: 0</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
var map = L.map('map').setView([53.96, -1.08], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Try to use user location
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(function(pos){
    map.setView([pos.coords.latitude, pos.coords.longitude], 15);
  });
}

// Layer containers
var reportLayer = L.layerGroup();
var reportedLayer = L.layerGroup();

// Zoom thresholds for showing markers
const MIN_ZOOM_SHOW = 14;
const MAX_ZOOM = 18;

// GeoJSON + Reported CSV URLs
const GEOJSON_URL = "Street_lighting.geojson";
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH2VV-FfOWWKyr4XRaVAPxWL-8zn2dKmYB_2XxxKG_b9IfJVtgGU5xcFje_wh7WW_AyGpDABQpMlFo/pub?gid=27103071&single=true&output=csv';

let geoData = [];
let geoLookup = {};

// --- Load GeoJSON ---
fetch(GEOJSON_URL).then(res=>res.json()).then(data=>{
  geoData = data.features;
  geoData.forEach(f=>{
    const id = f.properties.LP_UNIQUE_REF || f.properties.IIT_NE_ID;
    if(id) geoLookup[id] = f.geometry.coordinates;

    const desc = f.properties.DESCRIPTION || "";
    const road = f.properties.ROAD_NAME || "";
    const ward = f.properties.WARD || "";
    const loc = f.properties.LOCATION || "";

    const popup = `<b>Streetlight Ref:</b> ${id}<br>
                   <b>Description:</b> ${desc}<br>
                   <b>Road:</b> ${road}<br>
                   <b>Ward:</b> ${ward}<br>
                   <button onclick="reportIssue('${id}','Low')">Low (Could climb / boost someone to it)</button>
                   <button onclick="reportIssue('${id}','Med')">Med (2 tier / Loppy)</button>
                   <button onclick="reportIssue('${id}','High')">High (3 tier)</button>`;

    const marker = L.marker([f.geometry.coordinates[1], f.geometry.coordinates[0]]);
    marker.bindPopup(popup);
    reportLayer.addLayer(marker);
  });

  map.addLayer(reportLayer);
  updateReportVisibility();
});

// --- Reported CSV ---
function loadReportedLayer(){
  reportedLayer.clearLayers();
  Papa.parse(CSV_URL, {download:true, header:true, skipEmptyLines:true,
    complete:function(results){
      const reported = results.data.filter(r=>r.LP_UNIQUE_REF);
      document.getElementById('reported-counter').textContent = "Reported Flags: "+reported.length;

      reported.forEach(r=>{
        const id = r.LP_UNIQUE_REF;
        const issue = r.Issue_Description || '';
        const timestamp = r.Timestamp || '';
        const coords = geoLookup[id];
        if(!coords) return;

        let color = issue.toLowerCase().includes('med') ? 'orange' :
                    issue.toLowerCase().includes('high') ? 'red' : 'green';

        const marker = L.circleMarker([coords[1], coords[0]], {
          radius:8, fillColor:color, color:'#000', weight:1, opacity:1, fillOpacity:0.8
        }).bindPopup(`<b>Streetlight Ref:</b>${id}<br>
                      <b>Issue:</b>${issue}<br>
                      <b>Timestamp:</b>${timestamp}`);
        reportedLayer.addLayer(marker);
      });
    }
  });
}
loadReportedLayer();
setInterval(loadReportedLayer, 60000);

// --- Dropdown toggle ---
document.getElementById('layer-toggle').addEventListener('change',function(){
  const val = this.value;
  if(val==='report'){
    if(map.hasLayer(reportedLayer)) map.removeLayer(reportedLayer);
    map.addLayer(reportLayer);
    updateReportVisibility();
  } else if(val==='reported'){
    if(map.hasLayer(reportLayer)) map.removeLayer(reportLayer);
    map.addLayer(reportedLayer);
  }
});

// --- Show/hide report markers based on zoom ---
function updateReportVisibility(){
  const zoom = map.getZoom();
  document.getElementById('zoom-display').textContent = "Zoom: " + zoom;

  reportLayer.eachLayer(marker=>{
    if(zoom < MIN_ZOOM_SHOW){
      if(map.hasLayer(marker)) map.removeLayer(marker);
    } else if(zoom >= MAX_ZOOM){
      if(!map.hasLayer(marker)) marker.addTo(map);
    } else {
      if(!map.hasLayer(marker)) marker.addTo(map);
    }
  });
}
map.on('zoomend', updateReportVisibility);

// --- Reporting function ---
function reportIssue(id, level){
  const url = "https://docs.google.com/forms/d/e/1FAIpQLSf5Q35Lody4pbcu9SKh3jxh3R5qqqLNajV6gzQgci6PZRB7Dg/viewform?usp=pp_url" +
              "&entry.1636359810=" + encodeURIComponent(id) +
              "&entry.1808870260=" + encodeURIComponent(level);
  window.open(url,'_blank');
}
</script>
</body>
</html>
